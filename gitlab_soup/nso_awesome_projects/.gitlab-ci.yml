# NSO-DevOps-in-a-tin-can
# Author: @ponchotitlan
# 
# Pipeline definition for gitlab-runner
#
# The pipeline defined in this file aims to provide an example of the workflow for testing and deploying a NSO service package through different configuration means

include:
  - '/pipeline_utils/environments.yml'

variables:
  STAGING_NSO_CONTAINER: '$GITLAB_USER_LOGIN-NSO-$STAGING_NSO_VERSION'
  STAGING_NSO_DEVICE: '$STAGING_NETSIM_PREFIX-1'

stages:
  - build
  - test
  - deliver
  - deploy
  - cleanup

nso-staging-ğŸ—ï¸:
  stage: build
  script:
    - echo "(Build ğŸ—ï¸) Creating docker network"
    - docker network create nsotestenvnetwork

    - echo "(Build ğŸ—ï¸) Spinning up a NSO container for version v.$STAGING_NSO_VERSION (Docker image $STAGING_NSO_DOCKER_IMAGE)"
    - docker run -itd --network nsotestenvnetwork --env-file pipeline_utils/nso_setup.list --platform=linux/amd64 -p 8080:80 --name $STAGING_NSO_CONTAINER $STAGING_NSO_DOCKER_IMAGE

    - echo "(Build ğŸ—ï¸) Loading and compiling packages in the NSO container"
    - echo "(Build ğŸ—ï¸) Executing packages reload in the NSO container"       

testbed-staging-ğŸ—ï¸:
  stage: build
  script:
    - echo "(Build ğŸ—ï¸) Loading authgroups for netsims in the NSO container"
    - echo "(Build ğŸ—ï¸) Spinning up a NETSIM container (Docker image $STAGING_NETSIM_DOCKER_IMAGE)"
    - echo "(Build ğŸ—ï¸) Generating NETSIM configurations xml"
    - echo "(Build ğŸ—ï¸) Loading NETSIM configurations xml in the NSO container"
    - echo "(Build ğŸ—ï¸) Onboarding test devices in the NSO container"

test-1-ğŸ¤–:
  stage: test
  script:
    - echo "(Test ğŸ¤–) Executing test 1"

test-2-ğŸ¤–:
  stage: test
  script:
    - echo "(Test ğŸ¤–) Executing test 2"

test-3-ğŸ¤–:
  stage: test
  script:
    - echo "(Test ğŸ¤–) Executing test 3"

release-publishing-ğŸ“¦:
  stage: deliver
  script:
    - echo "(Deliver ğŸ“¦) Executing releasing"

deploy-production-ğŸ“¬:
  stage: deploy
  script:
    - echo "(Deploy ğŸ“¬) Deployment in production"

cleanup-ğŸ—‘ï¸:
  stage: cleanup
  script:
    - echo "(Cleanup ğŸ—‘ï¸) Deleting NSO container"
    - echo "(Cleanup ğŸ—‘ï¸) Deleting NETSIM containers"
    - echo "(Cleanup ğŸ—‘ï¸) Deleting docker network"
    - docker network rm nsotestenvnetwork